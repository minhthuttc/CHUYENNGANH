<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± √Ån C·ªßa T√¥i - DesignHub</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="logo">üé® DesignHub</a>
            <ul class="nav-links">
                <li><a href="dashboard.html">B·∫£ng ƒêi·ªÅu Khi·ªÉn</a></li>
                <li><a href="my-projects.html" class="active">D·ª± √Ån</a></li>
                <li><a href="payment-history.html">Thanh To√°n</a></li>
                <li><a href="profile.html">H·ªì S∆°</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1>üìÅ D·ª± √Ån C·ªßa T√¥i</h1>
            <button onclick="createNewProject()" class="btn btn-primary">+ T·∫°o D·ª± √Ån M·ªõi</button>
        </div>

        <!-- Tabs -->
        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; border-bottom: 2px solid var(--border-color);">
            <button onclick="filterProjects('all')" class="tab-btn active" data-tab="all">
                T·∫•t c·∫£
            </button>
            <button onclick="filterProjects('pending')" class="tab-btn" data-tab="pending">
                ƒêang tuy·ªÉn
            </button>
            <button onclick="filterProjects('in_progress')" class="tab-btn" data-tab="in_progress">
                ƒêang th·ª±c hi·ªán
            </button>
            <button onclick="filterProjects('review')" class="tab-btn" data-tab="review">
                ƒêang xem x√©t
            </button>
            <button onclick="filterProjects('completed')" class="tab-btn" data-tab="completed">
                Ho√†n th√†nh
            </button>
        </div>

        <!-- Loading State -->
        <div id="loadingState" style="text-align: center; padding: 3rem;">
            <div class="spinner"></div>
            <p style="margin-top: 1rem;">ƒêang t·∫£i d·ª± √°n...</p>
        </div>

        <!-- Projects List -->
        <div id="projectsList" style="display: none;">
            <!-- Projects will be loaded here -->
        </div>
    </main>

    <footer>
        <p>&copy; 2025 DesignHub - N·ªÅn t·∫£ng h·ª£p t√°c thi·∫øt k·∫ø ƒë·ªì h·ªça</p>
    </footer>

    <style>
        .tab-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            background: none;
            cursor: pointer;
            color: var(--text-gray);
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: var(--dark-brown);
        }

        .tab-btn.active {
            color: var(--dark-brown);
            border-bottom-color: var(--dark-brown);
            font-weight: bold;
        }

        .project-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            cursor: pointer;
        }

        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let allProjects = [];
        let currentFilter = 'all';

        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadProjects();
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
        }

        async function loadProjects() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('projectsList').style.display = 'none';

                const response = await fetch(`${API_URL}/projects`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ª± √°n');
                }

                allProjects = await response.json();
                console.log('Loaded projects:', allProjects);

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('projectsList').style.display = 'block';

                displayProjects(allProjects);
            } catch (error) {
                console.error('Error loading projects:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p style="color: red;">‚ùå L·ªói t·∫£i d·ª± √°n: ${error.message}</p>
                        <button onclick="loadProjects()" class="btn btn-secondary" style="margin-top: 1rem;">
                            üîÑ Th·ª≠ l·∫°i
                        </button>
                    </div>
                `;
            }
        }

        function displayProjects(projects) {
            const container = document.getElementById('projectsList');

            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <h3>Ch∆∞a c√≥ d·ª± √°n n√†o</h3>
                        <p style="color: var(--text-gray); margin: 1rem 0;">
                            B·∫Øt ƒë·∫ßu b·∫±ng c√°ch t·∫°o d·ª± √°n m·ªõi ho·∫∑c ·ª©ng tuy·ªÉn v√†o c√°c d·ª± √°n c√≥ s·∫µn
                        </p>
                        <button onclick="createNewProject()" class="btn btn-primary" style="margin-top: 1rem;">
                            + T·∫°o D·ª± √Ån M·ªõi
                        </button>
                    </div>
                `;
                return;
            }

            const html = projects.map(project => `
                <div class="project-card" onclick="viewProject('${project._id}')">
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: start;">
                        <div>
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0;">${project.title}</h3>
                                <span class="badge badge-${getStatusClass(project.status)}">
                                    ${getStatusText(project.status)}
                                </span>
                            </div>
                            <p style="color: var(--text-gray); margin: 0.5rem 0;">
                                ${project.description?.substring(0, 150)}${project.description?.length > 150 ? '...' : ''}
                            </p>
                            <div style="display: flex; gap: 2rem; margin-top: 1rem; font-size: 0.9rem; color: var(--text-gray);">
                                <span>üí∞ ${formatCurrency(project.budget)}</span>
                                <span>üìÖ ${new Date(project.deadline).toLocaleDateString('vi-VN')}</span>
                                <span>üë§ ${project.client?.fullName || 'N/A'}</span>
                                ${project.designer ? `<span>üé® ${project.designer.fullName}</span>` : ''}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            ${renderQuickActions(project)}
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        function renderQuickActions(project) {
            const user = JSON.parse(localStorage.getItem('user'));
            const isClient = user._id === project.client?._id;
            
            let actions = `
                <button onclick="event.stopPropagation(); viewProject('${project._id}')" 
                        class="btn btn-secondary" style="margin-bottom: 0.5rem;">
                    üëÅÔ∏è Xem
                </button>
            `;

            if (isClient && (project.status === 'review' || project.status === 'completed')) {
                actions += `
                    <button onclick="event.stopPropagation(); goToPayment('${project._id}')" 
                            class="btn btn-primary" style="margin-bottom: 0.5rem;">
                        üí≥ Thanh to√°n
                    </button>
                `;
            }

            return actions;
        }

        function filterProjects(status) {
            currentFilter = status;
            
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${status}"]`).classList.add('active');

            // Filter and display
            const filtered = status === 'all' 
                ? allProjects 
                : allProjects.filter(p => p.status === status);
            
            displayProjects(filtered);
        }

        function viewProject(projectId) {
            window.location.href = `project-detail.html?id=${projectId}`;
        }

        function goToPayment(projectId) {
            window.location.href = `payment.html?projectId=${projectId}`;
        }

        function createNewProject() {
            // Demo: Create a sample project
            if (confirm('T·∫°o d·ª± √°n demo ƒë·ªÉ test?')) {
                createDemoProject();
            }
        }

        async function createDemoProject() {
            try {
                const user = JSON.parse(localStorage.getItem('user'));
                
                const demoProject = {
                    title: 'Demo - Thi·∫øt K·∫ø ' + Date.now(),
                    description: 'D·ª± √°n demo ƒë·ªÉ test c√°c t√≠nh nƒÉng',
                    category: 'Logo Design',
                    budget: 5000000,
                    deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'review',
                    client: user._id
                };

                const response = await fetch(`${API_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(demoProject)
                });

                if (response.ok) {
                    alert('‚úÖ T·∫°o d·ª± √°n th√†nh c√¥ng!');
                    loadProjects();
                } else {
                    const error = await response.json();
                    alert('‚ùå L·ªói: ' + error.message);
                }
            } catch (error) {
                alert('‚ùå L·ªói: ' + error.message);
            }
        }

        // Helper functions
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': 'ƒêang tuy·ªÉn',
                'in_progress': 'ƒêang th·ª±c hi·ªán',
                'review': 'ƒêang xem x√©t',
                'completed': 'Ho√†n th√†nh',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return statusMap[status] || status;
        }

        function getStatusClass(status) {
            const classMap = {
                'pending': 'warning',
                'in_progress': 'info',
                'review': 'info',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return classMap[status] || 'secondary';
        }

        console.log('üìÅ My projects loaded');
    </script>
</body>
</html>
