<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Payment System</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .test-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--light-brown);
            border-radius: 10px;
        }
        .test-button {
            margin: 0.5rem;
        }
        .result {
            margin-top: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 5px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="logo">ğŸ¨ DesignHub - Test Payment</a>
            <ul class="nav-links">
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="payment-history.html">Lá»‹ch Sá»­</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <h1>ğŸ§ª Test Há»‡ Thá»‘ng Thanh ToÃ¡n</h1>

        <div class="test-section">
            <h2>1. Test Táº¡o Thanh ToÃ¡n</h2>
            <p>Táº¡o má»™t giao dá»‹ch thanh toÃ¡n máº«u</p>
            <button onclick="testCreatePayment()" class="btn btn-primary test-button">
                ğŸ’³ Test Táº¡o Thanh ToÃ¡n
            </button>
            <div id="result1" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>2. Test Láº¥y Lá»‹ch Sá»­</h2>
            <p>Láº¥y danh sÃ¡ch giao dá»‹ch cá»§a user hiá»‡n táº¡i</p>
            <button onclick="testGetHistory()" class="btn btn-primary test-button">
                ğŸ“œ Test Lá»‹ch Sá»­
            </button>
            <div id="result2" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>3. Test Thá»‘ng KÃª</h2>
            <p>Láº¥y thá»‘ng kÃª thanh toÃ¡n cá»§a user</p>
            <button onclick="testGetStats()" class="btn btn-primary test-button">
                ğŸ“Š Test Thá»‘ng KÃª
            </button>
            <div id="result3" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>4. Test Validation</h2>
            <p>Kiá»ƒm tra cÃ¡c trÆ°á»ng há»£p lá»—i</p>
            <button onclick="testValidation()" class="btn btn-primary test-button">
                âš ï¸ Test Validation
            </button>
            <div id="result4" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>5. Test UI Components</h2>
            <p>Má»Ÿ cÃ¡c trang thanh toÃ¡n</p>
            <button onclick="openPaymentPage()" class="btn btn-secondary test-button">
                ğŸ’³ Má»Ÿ Trang Thanh ToÃ¡n
            </button>
            <button onclick="openHistoryPage()" class="btn btn-secondary test-button">
                ğŸ“œ Má»Ÿ Lá»‹ch Sá»­
            </button>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:3000/api';

        async function testCreatePayment() {
            const result = document.getElementById('result1');
            result.style.display = 'block';
            result.textContent = 'Äang test...';

            try {
                // Láº¥y dá»± Ã¡n Ä‘áº§u tiÃªn Ä‘á»ƒ test
                const projectsRes = await fetch(`${API_URL}/projects`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const projects = await projectsRes.json();
                
                if (projects.length === 0) {
                    result.textContent = 'âŒ KhÃ´ng cÃ³ dá»± Ã¡n nÃ o Ä‘á»ƒ test. Vui lÃ²ng táº¡o dá»± Ã¡n trÆ°á»›c.';
                    return;
                }

                const testProject = projects[0];
                const paymentData = {
                    projectId: testProject._id,
                    paymentMethod: 'bank_transfer',
                    note: 'Test payment from test page',
                    amount: (testProject.budget || 5000000) * 1.05
                };

                const response = await fetch(`${API_URL}/payments/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(paymentData)
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.textContent = `âœ… THÃ€NH CÃ”NG!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    result.textContent = `âŒ Lá»–I!\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                result.textContent = `âŒ EXCEPTION!\n\n${error.message}`;
            }
        }

        async function testGetHistory() {
            const result = document.getElementById('result2');
            result.style.display = 'block';
            result.textContent = 'Äang test...';

            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const response = await fetch(`${API_URL}/payments/history?userId=${user._id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.textContent = `âœ… THÃ€NH CÃ”NG! TÃ¬m tháº¥y ${data.length} giao dá»‹ch\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    result.textContent = `âŒ Lá»–I!\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                result.textContent = `âŒ EXCEPTION!\n\n${error.message}`;
            }
        }

        async function testGetStats() {
            const result = document.getElementById('result3');
            result.style.display = 'block';
            result.textContent = 'Äang test...';

            try {
                const user = JSON.parse(localStorage.getItem('user'));
                const response = await fetch(`${API_URL}/payments/stats/${user._id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    result.textContent = `âœ… THÃ€NH CÃ”NG!\n\n${JSON.stringify(data, null, 2)}`;
                } else {
                    result.textContent = `âŒ Lá»–I!\n\n${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                result.textContent = `âŒ EXCEPTION!\n\n${error.message}`;
            }
        }

        async function testValidation() {
            const result = document.getElementById('result4');
            result.style.display = 'block';
            result.textContent = 'Äang test validation...\n\n';

            const tests = [
                {
                    name: 'Test thiáº¿u projectId',
                    data: { paymentMethod: 'bank_transfer', amount: 5000000 }
                },
                {
                    name: 'Test phÆ°Æ¡ng thá»©c khÃ´ng há»£p lá»‡',
                    data: { projectId: '123', paymentMethod: 'invalid', amount: 5000000 }
                },
                {
                    name: 'Test thiáº¿u amount',
                    data: { projectId: '123', paymentMethod: 'bank_transfer' }
                }
            ];

            for (const test of tests) {
                try {
                    const response = await fetch(`${API_URL}/payments/create`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify(test.data)
                    });

                    const data = await response.json();
                    result.textContent += `${test.name}:\n`;
                    result.textContent += `Status: ${response.status}\n`;
                    result.textContent += `Message: ${data.message}\n\n`;
                } catch (error) {
                    result.textContent += `${test.name}: ERROR - ${error.message}\n\n`;
                }
            }
        }

        function openPaymentPage() {
            // Láº¥y projectId Ä‘áº§u tiÃªn
            fetch(`${API_URL}/projects`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(res => res.json())
            .then(projects => {
                if (projects.length > 0) {
                    window.open(`payment.html?projectId=${projects[0]._id}`, '_blank');
                } else {
                    alert('KhÃ´ng cÃ³ dá»± Ã¡n nÃ o. Vui lÃ²ng táº¡o dá»± Ã¡n trÆ°á»›c.');
                }
            });
        }

        function openHistoryPage() {
            window.open('payment-history.html', '_blank');
        }

        // Check auth
        if (!localStorage.getItem('token')) {
            alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c!');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
