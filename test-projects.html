<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Projects - DesignHub</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <nav>
            <a href="index.html" class="logo">üé® DesignHub - Test</a>
            <ul class="nav-links">
                <li><a href="my-projects.html">D·ª± √Ån</a></li>
                <li><a href="demo-payment.html">Demo</a></li>
            </ul>
        </nav>
    </header>

    <main class="container">
        <h1>üß™ Test D·ª± √Ån</h1>

        <div class="card" style="margin: 2rem 0;">
            <h2>Ki·ªÉm Tra Database</h2>
            <button onclick="checkProjects()" class="btn btn-primary">
                üîç Ki·ªÉm Tra D·ª± √Ån
            </button>
            <button onclick="createTestProject()" class="btn btn-secondary" style="margin-left: 1rem;">
                ‚ûï T·∫°o D·ª± √Ån Test
            </button>
        </div>

        <div id="result" style="display: none;" class="card">
            <h3>K·∫øt Qu·∫£</h3>
            <pre id="resultContent" style="background: #f5f5f5; padding: 1rem; border-radius: 5px; overflow-x: auto;"></pre>
        </div>

        <div id="projectsList" style="margin-top: 2rem;"></div>
    </main>

    <script>
        const API_URL = 'http://localhost:3000/api';

        async function checkProjects() {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            resultDiv.style.display = 'block';
            resultContent.textContent = 'ƒêang ki·ªÉm tra...';

            try {
                const response = await fetch(`${API_URL}/projects`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const projects = await response.json();
                
                resultContent.textContent = `
‚úÖ K·∫øt n·ªëi th√†nh c√¥ng!
üìä T·ªïng s·ªë d·ª± √°n: ${projects.length}

${projects.length > 0 ? 'Danh s√°ch d·ª± √°n:\n' + projects.map((p, i) => `
${i + 1}. ${p.title}
   - ID: ${p._id}
   - Tr·∫°ng th√°i: ${p.status}
   - Kh√°ch h√†ng: ${p.client?.fullName || 'N/A'}
   - Ng√¢n s√°ch: ${p.budget?.toLocaleString('vi-VN')} VNƒê
   - Link: http://localhost:3000/project-detail.html?id=${p._id}
`).join('\n') : '‚ö†Ô∏è Ch∆∞a c√≥ d·ª± √°n n√†o trong database!'}
                `;

                // Display clickable list
                if (projects.length > 0) {
                    displayProjectsList(projects);
                }
            } catch (error) {
                resultContent.textContent = `‚ùå L·ªói: ${error.message}`;
                console.error('Error:', error);
            }
        }

        function displayProjectsList(projects) {
            const listDiv = document.getElementById('projectsList');
            listDiv.innerHTML = `
                <div class="card">
                    <h3>üìÅ Danh S√°ch D·ª± √Ån (Click ƒë·ªÉ xem)</h3>
                    ${projects.map(p => `
                        <div style="padding: 1rem; border: 1px solid var(--border-color); border-radius: 5px; margin: 0.5rem 0; cursor: pointer; transition: all 0.3s;"
                             onclick="openProject('${p._id}')"
                             onmouseover="this.style.background='var(--light-brown)'"
                             onmouseout="this.style.background='white'">
                            <strong>${p.title}</strong>
                            <br>
                            <small style="color: var(--text-gray);">
                                ID: ${p._id} | 
                                Tr·∫°ng th√°i: ${p.status} | 
                                ${p.budget?.toLocaleString('vi-VN')} VNƒê
                            </small>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openProject(projectId) {
            window.open(`project-detail.html?id=${projectId}`, '_blank');
        }

        async function createTestProject() {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('resultContent');
            
            resultDiv.style.display = 'block';
            resultContent.textContent = 'ƒêang t·∫°o d·ª± √°n test...';

            try {
                const user = JSON.parse(localStorage.getItem('user'));
                
                if (!user) {
                    throw new Error('Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!');
                }

                const testProject = {
                    title: `Test Project ${Date.now()}`,
                    description: 'D·ª± √°n test ƒë·ªÉ ki·ªÉm tra t√≠nh nƒÉng xem chi ti·∫øt v√† thanh to√°n',
                    category: 'Logo Design',
                    budget: 5000000,
                    deadline: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
                    status: 'review', // S·∫µn s√†ng thanh to√°n
                    client: user._id,
                    skills: ['Adobe Illustrator', 'Logo Design', 'Branding']
                };

                const response = await fetch(`${API_URL}/projects`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(testProject)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Kh√¥ng th·ªÉ t·∫°o d·ª± √°n');
                }

                const result = await response.json();
                const project = result.project || result;

                resultContent.textContent = `
‚úÖ T·∫°o d·ª± √°n th√†nh c√¥ng!

Th√¥ng tin d·ª± √°n:
- T√™n: ${project.title}
- ID: ${project._id}
- Tr·∫°ng th√°i: ${project.status}
- Ng√¢n s√°ch: ${project.budget?.toLocaleString('vi-VN')} VNƒê

Link xem chi ti·∫øt:
http://localhost:3000/project-detail.html?id=${project._id}

Link thanh to√°n:
http://localhost:3000/payment.html?projectId=${project._id}
                `;

                // Add buttons
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.marginTop = '1rem';
                buttonsDiv.innerHTML = `
                    <button onclick="window.open('project-detail.html?id=${project._id}', '_blank')" class="btn btn-primary">
                        üëÅÔ∏è Xem Chi Ti·∫øt
                    </button>
                    <button onclick="window.open('payment.html?projectId=${project._id}', '_blank')" class="btn btn-secondary" style="margin-left: 0.5rem;">
                        üí≥ Thanh To√°n
                    </button>
                `;
                document.getElementById('result').appendChild(buttonsDiv);

                // Refresh list
                setTimeout(checkProjects, 1000);
            } catch (error) {
                resultContent.textContent = `‚ùå L·ªói: ${error.message}`;
                console.error('Error:', error);
            }
        }

        // Auto check on load
        if (localStorage.getItem('token')) {
            checkProjects();
        } else {
            document.getElementById('result').style.display = 'block';
            document.getElementById('resultContent').textContent = '‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc!\n\nƒêang chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p...';
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
        }
    </script>
</body>
</html>
